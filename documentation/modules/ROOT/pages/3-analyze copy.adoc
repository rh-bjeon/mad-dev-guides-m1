= 3. Analyze - 25 minutes
:imagesdir: ../assets/images

== Goals of this lab

As you have realized in the previous *assessment* exercise, you need to analyze the legacy applications in terms of identifying the actual lines of code for the modernization issues as well as estimating time and effort for the modernization project.

The goal of this exercise is to analyze the _customers_ application by scanning its source code and properties using the `Analysis` capability in MTA. Then you'll review the analysis report and get started with the actual code modification.

MTA _Analysis_ is used by organizations for:

* Planning and work estimation
* Identifying migration issues and providing solutions
* Detailed reporting

And has several capabilities such as:

* Built-in rules and migration paths
* Rule extensibility and customization
* Ability to analyze source code or application archives

Read more about it in the https://access.redhat.com/documentation/en-us/migration_toolkit_for_applications/6.0/html-single/introduction_to_the_migration_toolkit_for_applications/index#new-mta-features_getting-started-guide[MTA Features]

== 3.1. Analyze Customers Application using MTA

First, you need to configure *Git repositories* to refer to your link:https://gitea.%SUBDOMAIN%/%USERID%/modern-app-dev[Gitea repository^] when you analyze your inventory and applications using MTA.

In *Administration* view, select *Repositories > Git*. `Toggle` the *Consume insecure Git repositories* switch to the right.

image::mta-admin-git.png[admin git]

[NOTE]
====
You can also log in to the Gitea repository with the following credentials.

* Username - `%USERID%`
* Password - `{openshift-password}`
====

Go back to the `Application inventory` page in the *Migration* perspective. Click on pencil (edit) icon for the customers inventory.

Update application with the following source code information.

* Repository type - `Git`
* Source Repository - `https://gitea.%SUBDOMAIN%/%USERID%/modern-app-dev.git`
* Branch - `ocp-4.15`
* Root path - `customers-tomcat-legacy`

image::application-update-git.png[application-update-git]

Select `Save`.

Select the `Analysis` tab. When you click on the `Customers` application, `Analyze` button will be enabled. Then, click on *Analyze*.

image::application-analysis.png[application-analysis]

=== 3.1.1. Analysis mode

Select `Source dode` in Analysis mode popup.

image::add-applications.png[Add applications]

Click on `Next`.

=== 3.1.2. Set targets

You will now be presented with options for transformation targets. Here we will select several targets based on the technologies we are moving to:

Since this is going to be a linux container, it makes sense to do a sanity check to avoid things like Windows filesystem paths and other non-container- or non-Linux-friendly issues. We also going to investigate removing our reliance on a proprietary JDK distribution, so we going to select OpenJDK as a target.

Click on `Containers`, `Linux`, and `OpenJDK` as the targets.

image::configure-analysis-checked.png[Configure Analysis]

Click on `Next`.

Select `Application and internal dependencies only` for the scope of dependencies.

image::packages.png[Select packages]

Click on `Next`.

=== 3.1.3. Advanced

You will now be presented with options for custom rules.

image::custom-rules.png[Custom rules]

MTA Analysis uses a custom rule engine for the analysis. It comes with many rules out of the box to support the different migration paths, but it can be extended. Custom rules can be developed with a very simple XML syntax and used as part of the analysis. We've provided some custom rules which will detect the usage of a specific library that we know has been used at Globex in the past and make suggestions for changes to be performed to remove it.

Select `Repository` tab to refer to a custom rule (`corporate-framework-config.windup.xml`) in the *customrules* directory of your Gitea repository.

Key in the following information in the repository page.

* Repository type - `Git`
* Source Repository - `https://gitea.%SUBDOMAIN%/%USERID%/modern-app-dev.git`
* Branch - `ocp-4.15`
* Root path - `customrules`

[NOTE]
====
In case you don't see `None` in the `Associated credentials`, please leave it since the field is not mandatory.
====

image::add-repository-customrules.png[add-repository-customrules]

Click on `Next`.

Next, you will be presented with options to fine tune the analysis. For now we will stick with the default options.

image::fine-tune.png[Fine tuning]

Click on `Next`.

Lastly, we are presented with a summary of the configuration for our analysis.

image::finish-project.png[Finish project]

Click on `Run`. This will get the analysis on the `Scheduled` status while the MTA tasking system requests OpenShift for resources to allocate the analysis pod. MTA fully leverages the resource management capabilities of OpenShift to scale the analysis based on the available resources on the project in which it has been deployed. Individual analysis pods for each application are be created (one in our case), and the analysis runs as soon as there are available resources.

image::mta-application-analysis-scheduled.png[Analysis scheduled]

[NOTE]
====
The analysis may take a few minutes to start as it must pull container images for the analyzer engine before executing.
====

Once the image is pulled and the analyzer pod is running, the analysis will change its status to `In Progress`. The application source code is now being analyzed, which could take some additional minutes depending on the workload on the cluster.  When the analysis finishes, the status will change to `Completed`.

== 3.2. Understanding the analysis results

Application analysis provides insights on several aspects of the application itself, that can be accessed through its _Application Profile_. Once the analysis is finished (the `Completed` status can be seen in the _Analysis_ column), click on the `Customers` application to open its _Application Profile_.

=== 3.2.1. Effort

MTA helps you determine the effort required to migrate a certain application by aggregating the individual effort for each issue occurrence found in the source code. Effort is expressed in Story Points, which are an abstract metric commonly used in Agile software development to estimate the relative level of effort needed to implement a feature or change. Migration Toolkit for Application uses story points to express the level of effort needed to migrate particular application constructs, and the application as a whole. There is not a direct translation between story points and work hours, since each organization has different teams and skills, but they provide a comparative way to understand how complex migrating an application can be. The level of effort will vary greatly depending on the size and complexity of the application(s) to migrate. Once an application has been analyzed, the `Effort` metric will be available as a column in the _Application Inventory_ table and in the application profile.

image::mta-application-analysis-effort.png[Effort]

=== 3.2.2. Technology stack

The first and most straightforward insight the analysis outputs would be identifying the technology stack and associating it to the _Application Profile_ as tags, so that information can later be leveraged to automatically assign archetypes across the portfolio.

Click on the _Tags_ tab to browse the tags associated with the `Customers` application. Notice that this tab now shows way more tags than what we saw when we first browsed them when we were introducing the _Application Profile_ concept. These tags have been automatically applied by the analyzer engine based on the technologies it was able to identify while running the analysis. To see which tags were specifically applied by the analyzer, click on the `Source` filter under _Filter by_ and select `Analysis`.

image::mta-application-analysis-tags.png[Analysis tags]

=== 3.2.3. Issues

In the MTA jargon, `Issues` are antipatterns found in applications that might prevent them from running in a given platform. As with Dependencies, MTA allows browsing issues individually on a per application basis or globally at portfolio level, allowing users to focus on certain applications or identify trends across the entire application portfolio respectively. A shortcut to the issues of a given application can be found on the details tab from the _Application Profile_.

Click on the `Customers` application to open the _Application Profile_ and then click on `Issues`. That will navigate to the `Single Application` tab from the `Issues` view with filters preapplied to display all the issues from the `Customers` application:

image::mta-application-analysis-issues.png[Issues]

The list includes direct access the usage of hardcoded IPs, which is aligned with our findings during the assessment. It appears that the custom rule we specified before got triggered as well. If we click on an issue, we get more information about it, including code snippets, links to external information and the list of affected files.

Expand the `Hardcoded IP Address` row from the `Issues` table and click on `Affected Files`:

image::mta-application-analysis-issues-ip-files.png[Issues]

This gives you the list of affected files for this problem. Click on the first one and a modal window will open with further details, including the exact code snippet in which the issue was found, alongside an explanation of how to solve it:

image::mta-application-analysis-issues-ip-snippet.png[Issues]

The analyzer has indeed found a static IP, but this comes from a properties file, so shouldn't be considered that much of an issue if for example the database, which is the asset being accessed here, remains outside of OpenShift in its original location. Close the modal window and the `Affected Files` drawer.

Now expand the `File system - Java IO` row. This corresponds to the triggering of the custom rule that looks for the usage of the custom corporate configuration library. Click on `View affected files` to learn more about how widespread the usage of that library is:

image::mta-application-analysis-issues-config-files.png[Issues]

image::mta-application-analysis-issues-config-files-2.png[Issues]

Only the `PersistenceConfig` class seems to be affected by the issue. Click on it to know more:

image::mta-application-analysis-issues-config-snippet1.png[Issues]

Looks like *6* occurrences of the same issue have been found in the file, click on the `All incident` tabs from the modal window to confirm all the issues:

image::mta-application-analysis-issues-config-snippet2.png[Issues]

This means that the analyzer has found the `ApplicationConfiguration` class from the custom configuration library being used twice in the `PersistenceConfig` class. We'll have to replace that with something more standard, following the guidelines provided by the hints in the usage. This is something we'll tackle in the next module. For the moment close all modals and head back to the _Application Inventory_ view.

=== 3.2.4. Dependencies

The analysis in MTA also gathers detailed information about dependencies used by applications in the portfolio. To get a list of the dependencies for the `Customers` application, open its _Application Profile_ and click on the `Dependencies` link from the `Details` tab. This will navigate to the `Dependencies` view with the filter for the `Customers` application preapplied:

image::mta-application-analysis-dependencies.png[Issues]

Clicking on a dependency will provide additional details about how its relationship with each application in the portfolio that relies on it, including:

* Version of the dependency, with a link to Maven Central.
* Management relationship, indicating whether the dependency is managed by a dependency manager like Maven or it was simply found embedded in a binary.
* Relationship, which defines whether the dependency is direct or transitive.

== Summary

You have now successfully analyzed the legacy application to learn what migration issues you have. You'll refactor the application to fix the issues in the next module. Then, you'll deploy the modernized application to Red Hat OpenShift. Let's go!
